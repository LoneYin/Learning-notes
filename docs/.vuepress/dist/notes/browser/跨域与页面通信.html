<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>跨域与页面通信 | 学习笔记</title>
    <meta name="description" content="构建自己的前端知识体系">
    
    
    <link rel="preload" href="/assets/css/0.styles.a4aa4dff.css" as="style"><link rel="preload" href="/assets/js/app.d90b1a7d.js" as="script"><link rel="preload" href="/assets/js/2.ddf9653e.js" as="script"><link rel="preload" href="/assets/js/28.f12de4e4.js" as="script"><link rel="prefetch" href="/assets/js/10.2822c8d4.js"><link rel="prefetch" href="/assets/js/11.953eb217.js"><link rel="prefetch" href="/assets/js/12.08cd3bc9.js"><link rel="prefetch" href="/assets/js/13.3ea07363.js"><link rel="prefetch" href="/assets/js/14.08d3c49e.js"><link rel="prefetch" href="/assets/js/15.99b05918.js"><link rel="prefetch" href="/assets/js/16.9b87fae1.js"><link rel="prefetch" href="/assets/js/17.e263599c.js"><link rel="prefetch" href="/assets/js/18.a9e58c70.js"><link rel="prefetch" href="/assets/js/19.450252cb.js"><link rel="prefetch" href="/assets/js/20.67219f9a.js"><link rel="prefetch" href="/assets/js/21.83fb62ce.js"><link rel="prefetch" href="/assets/js/22.454161a4.js"><link rel="prefetch" href="/assets/js/23.cd0dc78c.js"><link rel="prefetch" href="/assets/js/24.62650fe5.js"><link rel="prefetch" href="/assets/js/25.5fa89824.js"><link rel="prefetch" href="/assets/js/26.69c19d16.js"><link rel="prefetch" href="/assets/js/27.014678fc.js"><link rel="prefetch" href="/assets/js/29.7699ebd7.js"><link rel="prefetch" href="/assets/js/3.b0a6775b.js"><link rel="prefetch" href="/assets/js/30.9261d85c.js"><link rel="prefetch" href="/assets/js/31.57536ebb.js"><link rel="prefetch" href="/assets/js/32.a73b6dce.js"><link rel="prefetch" href="/assets/js/33.36884a86.js"><link rel="prefetch" href="/assets/js/34.79921d3e.js"><link rel="prefetch" href="/assets/js/35.f0f27945.js"><link rel="prefetch" href="/assets/js/36.2a08bebc.js"><link rel="prefetch" href="/assets/js/37.294494f7.js"><link rel="prefetch" href="/assets/js/38.20d8a33d.js"><link rel="prefetch" href="/assets/js/39.5bc82999.js"><link rel="prefetch" href="/assets/js/4.554dccb8.js"><link rel="prefetch" href="/assets/js/40.b64c9fda.js"><link rel="prefetch" href="/assets/js/41.ca3e1133.js"><link rel="prefetch" href="/assets/js/42.34bdf90e.js"><link rel="prefetch" href="/assets/js/5.7ec69b64.js"><link rel="prefetch" href="/assets/js/6.9a961699.js"><link rel="prefetch" href="/assets/js/7.7e6eebce.js"><link rel="prefetch" href="/assets/js/8.4a1300d9.js"><link rel="prefetch" href="/assets/js/9.5d664d52.js">
    <link rel="stylesheet" href="/assets/css/0.styles.a4aa4dff.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">学习笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/notes/" class="nav-link router-link-active">前端笔记</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/notes/" class="nav-link router-link-active">前端笔记</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>浏览器知识</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/notes/browser/浏览器的进程与线程.html" class="sidebar-link">浏览器的进程与线程</a></li><li><a href="/notes/browser/浏览器的渲染原理.html" class="sidebar-link">浏览器的渲染原理</a></li><li><a href="/notes/browser/浏览器JS引擎.html" class="sidebar-link">浏览器JS引擎（V8）</a></li><li><a href="/notes/browser/浏览器EventLoop.html" class="sidebar-link">EventLoop</a></li><li><a href="/notes/browser/浏览器缓存策略.html" class="sidebar-link">浏览器缓存策略</a></li><li><a href="/notes/browser/跨域与页面通信.html" class="active sidebar-link">跨域与页面通信</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/notes/browser/跨域与页面通信.html#造成跨域的原因" class="sidebar-link">造成跨域的原因</a></li><li class="sidebar-sub-header"><a href="/notes/browser/跨域与页面通信.html#浏览器同源策略" class="sidebar-link">浏览器同源策略</a></li><li class="sidebar-sub-header"><a href="/notes/browser/跨域与页面通信.html#为什么会有跨域" class="sidebar-link">为什么会有跨域</a></li><li class="sidebar-sub-header"><a href="/notes/browser/跨域与页面通信.html#跨域解决方案" class="sidebar-link">跨域解决方案</a></li><li class="sidebar-sub-header"><a href="/notes/browser/跨域与页面通信.html#浏览器多个窗口之间的通信方法" class="sidebar-link">浏览器多个窗口之间的通信方法</a></li></ul></li><li><a href="/notes/browser/浏览器DOM事件与事件监听.html" class="sidebar-link">浏览器DOM事件与事件监听</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>网络知识</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/notes/network/TCP与DNS.html" class="sidebar-link">TCP协议与DNS协议</a></li><li><a href="/notes/network/HTTP协议.html" class="sidebar-link">HTTP/HTTPS/HTTP2</a></li><li><a href="/notes/network/GET和POST请求的区别.html" class="sidebar-link">GET请求和POST请求的区别</a></li><li><a href="/notes/network/Web安全.html" class="sidebar-link">Web安全 —— XSS 与 CSRF</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>JavaScript进阶</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/notes/advanced/JS执行上下文栈.html" class="sidebar-link">JS执行上下文栈</a></li><li><a href="/notes/advanced/原型链与继承.html" class="sidebar-link">原型链继承</a></li><li><a href="/notes/advanced/Iterator和Generator.html" class="sidebar-link">Iterator和Generator</a></li><li><a href="/notes/advanced/Promise.html" class="sidebar-link">Promise</a></li><li><a href="/notes/advanced/Proxy.html" class="sidebar-link">Proxy</a></li><li><a href="/notes/advanced/节流和防抖.html" class="sidebar-link">函数的节流和防抖</a></li><li><a href="/notes/advanced/函数柯里化.html" class="sidebar-link">函数柯里化和偏函数</a></li><li><a href="/notes/advanced/bind和call和apply.html" class="sidebar-link">手写 bind/call/apply</a></li><li><a href="/notes/advanced/另一个角度理解this.html" class="sidebar-link">从另一个角度理解this</a></li><li><a href="/notes/advanced/闭包.html" class="sidebar-link">闭包</a></li><li><a href="/notes/advanced/常见算法.html" class="sidebar-link">常见算法</a></li><li><a href="/notes/advanced/单例模式.html" class="sidebar-link">JavaScript 中单例设计模式的应用</a></li><li><a href="/notes/advanced/观察者模式.html" class="sidebar-link">观察者模式的简单实现</a></li><li><a href="/notes/advanced/使用setTimeout模拟setInterval.html" class="sidebar-link">用 setTimeout 实现 setInterval</a></li><li><a href="/notes/advanced/new运算符.html" class="sidebar-link">new运算符到底做了什么</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>其他知识</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/notes/others/模块加载机制.html" class="sidebar-link">模块加载机制</a></li><li><a href="/notes/others/前端性能优化.html" class="sidebar-link">前端性能优化</a></li><li><a href="/notes/others/移动端适配方案.html" class="sidebar-link">移动端适配方案</a></li><li><a href="/notes/others/Vue与React的区别.html" class="sidebar-link">Vue与React的区别</a></li><li><a href="/notes/others/面试题整理.html" class="sidebar-link">一些JS面试题整理</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>个人随笔</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/notes/essay/给ReactRouter添加转场动画.html" class="sidebar-link">给React-Router添加路由页面切换时的过渡动画</a></li><li><a href="/notes/essay/Vue列表渲染中的key的作用.html" class="sidebar-link">key在Vue渲染列表时究竟起到了什么作用</a></li><li><a href="/notes/essay/vue源码阅读知识点整理.html" class="sidebar-link">Vue 源码阅读知识点整理</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="跨域与页面通信"><a href="#跨域与页面通信" class="header-anchor">#</a> 跨域与页面通信</h1> <h2 id="造成跨域的原因"><a href="#造成跨域的原因" class="header-anchor">#</a> 造成跨域的原因</h2> <p>简单说就是浏览器的同源策略，资源下载你随便下，但是访问跨域接口和操作跨域页面的DOM/BOM(另一个window)，对不起，不允许。</p> <ul><li>DOM同源策略：禁止对不同源页面DOM进行操作。这里主要场景是iframe跨域的情况，不同域名的iframe是限制互相访问的。</li> <li>XmlHttpRequest同源策略：禁止使用XHR对象向不同源的服务器地址发起HTTP请求。</li></ul> <h2 id="浏览器同源策略"><a href="#浏览器同源策略" class="header-anchor">#</a> 浏览器同源策略</h2> <p>同源策略限制了从同一个源加载的文档或脚本如何与来自另一个源的资源进行交互。这是一个用于隔离潜在恶意文件的重要安全机制。</p> <p>同源是指&quot;协议+域名+端口&quot;三者相同，即便两个不同的域名指向同一个 ip 地址，也非同源。</p> <p>同源策略对 ajax 的限制不是不能发送，是有些浏览器会对返回结果做拦截。</p> <p>浏览器中的大部分内容都是受同源策略限制的，但是以下三个标签可以不受限制：</p> <ul><li><code>&lt;img src=XXX&gt;</code></li> <li><code>&lt;link href=XXX&gt;</code></li> <li><code>&lt;script src=XXX&gt;</code></li></ul> <h2 id="为什么会有跨域"><a href="#为什么会有跨域" class="header-anchor">#</a> 为什么会有跨域</h2> <h2 id="跨域解决方案"><a href="#跨域解决方案" class="header-anchor">#</a> 跨域解决方案</h2> <blockquote><p>跨域请求方案</p></blockquote> <ol><li><p><strong>CORS</strong></p></li> <li><p><strong>JSONP</strong></p></li> <li><p><strong>代理服务器或 Nginx 反向代理</strong></p></li></ol> <blockquote><p>余下为跨域页面通信方案</p></blockquote> <ol start="4"><li><p><strong>postMessage</strong> 需要在浏览器内同时打开，并且两个页面都提供支持</p></li> <li><p><strong>WebSocket</strong> 需要服务端支持和各客户端页面支持</p></li> <li><p><strong>window.name + iframe</strong>：window.name 属性值在不同的页面（甚至不同域名）加载后依旧存在，并且可以支持非常长的 name 值，我们可以利用这个特点进行跨域。</p></li> <li><p><strong>location.hash + iframe</strong>：a.html 欲与 c.html 跨域相互通信，通过中间页 b.html 来实现。 三个页面，不同域之间利用 iframe 的 location.hash 传值，相同域之间直接 js 访问来通信。</p></li> <li><p><strong>document.domain + iframe</strong>： 该方式只能用于二级域名相同的情况下，比如 a.test.com 和 b.test.com 适用于该方式，我们只需要给页面添加 document.domain ='test.com' 表示二级域名都相同就可以实现跨域，两个页面都通过 js 强制设置 document.domain 为基础主域，就实现了同域。</p></li></ol> <h3 id="cors"><a href="#cors" class="header-anchor">#</a> CORS</h3> <p>浏览器会自动进行 CORS 通信，实现 CORS 通信的关键是后端。只要后端实现了 CORS，就实现了跨域。</p> <p>服务端设置 Access-Control-Allow-Origin 就可以开启 CORS。 该属性表示哪些域名可以访问资源，如果设置通配符则表示所有网站都可以访问资源。</p> <p>虽然设置 CORS 和前端没什么关系，但是通过这种方式解决跨域问题的话，会在发送请求时出现两种情况，分别为简单请求和复杂请求。</p> <h4 id="简单请求"><a href="#简单请求" class="header-anchor">#</a> 简单请求</h4> <p>只要同时满足以下两大条件，就属于简单请求
条件 1：使用下列方法之一：</p> <ul><li>GET</li> <li>HEAD</li> <li>POST</li></ul> <p>条件 2：Content-Type 的值仅限于下列三者之一：</p> <ul><li>text/plain</li> <li>multipart/form-data</li> <li>application/x-www-form-urlencoded</li></ul> <h4 id="复杂请求"><a href="#复杂请求" class="header-anchor">#</a> 复杂请求</h4> <p>不符合以上条件的请求就肯定是复杂请求了。 复杂请求的 CORS 请求，会在正式通信之前，增加一次 HTTP 查询请求，称为&quot;预检&quot;请求,该请求是 option 方法的，通过该请求来知道服务端是否允许跨域请求。可以通过 Access-Control-Max-Age 来设置预检的有效时间</p> <h3 id="jsonp"><a href="#jsonp" class="header-anchor">#</a> JSONP</h3> <ul><li><h4 id="原理"><a href="#原理" class="header-anchor">#</a> 原理</h4>
利用 <code>&lt;script&gt;</code> 标签没有跨域限制的漏洞，网页可以得到从其他来源动态产生的 JSON 数据。JSONP 请求一定需要对方的服务器做支持才可以。</li> <li><h4 id="和-ajax-的对比"><a href="#和-ajax-的对比" class="header-anchor">#</a> 和 Ajax 的对比</h4>
JSONP 和 AJAX 相同，都是客户端向服务器端发送请求，从服务器端获取数据的方式。但 AJAX 属于同源策略，JSONP 属于非同源策略（跨域请求），JSONP 只支持 GET 方法</li> <li><h4 id="jsonp-的优缺点"><a href="#jsonp-的优缺点" class="header-anchor">#</a> JSONP 的优缺点</h4>
JSONP 优点是简单兼容性好，可用于解决主流浏览器的跨域数据访问的问题（重点关照 IE10 以下）。缺点是仅支持 GET 方法具有局限性，不安全可能会遭受 XSS 攻击(如果服务器被黑返回了XSS代码，或者Content-Type没有定义好，定义成text/html浏览器就会渲染)。</li> <li><h4 id="jsonp-的实现流程"><a href="#jsonp-的实现流程" class="header-anchor">#</a> JSONP 的实现流程</h4> <ul><li>声明一个回调函数，其函数名(如 show)当做参数值，要传递给跨域请求数据的服务器，函数形参为要获取目标数据(服务器返回的 data)。</li> <li>创建一个<code>&lt;script&gt;</code>标签，把那个跨域的 API 数据接口地址，赋值给 script 的 src,还要在这个地址中向服务器传递该函数名（可以通过问号传参:?callback=show）。</li> <li>服务器接收到请求后，需要进行特殊的处理：把传递进来的函数名和它需要给你的数据拼接成一个字符串,例如：传递进去的函数名是 show，它准备好的数据是 show(data')。</li> <li>最后服务器把准备的数据通过 HTTP 协议返回给客户端，客户端再调用执行之前声明的回调函数（show），对返回的数据进行操作。</li></ul></li></ul> <h3 id="postmessage"><a href="#postmessage" class="header-anchor">#</a> postMessage</h3> <p>postMessage 是 HTML5 XMLHttpRequest Level 2 中的 API，且是为数不多可以跨域操作的 window 属性之一，它可用于解决以下方面的问题:</p> <blockquote><ul><li>页面和其打开的新窗口的数据传递</li> <li>多窗口之间消息传递</li> <li>页面与嵌套的 iframe 消息传递</li> <li>上面三个场景的跨域数据传递</li></ul></blockquote> <p>postMessage()方法允许来自不同源的脚本采用异步方式进行有限的通信，可以实现跨文本档、多窗口、跨域消息传递。</p> <p><code>otherWindow.postMessage(message, targetOrigin, [transfer]);</code></p> <p>window 或者 iframe 的 contentwindow 都可调用这个方法，参数如下：</p> <ul><li><strong>message</strong>: 将要发送到其他 window 的数据。</li> <li><strong>targetOrigin</strong>:通过窗口的 origin 属性来指定哪些窗口能接收到消息事件，其值可以是字符串<code>\*</code>（表示无限制）或者一个 URI。在发送消息的时候，如果目标窗口的协议、主机地址或端口这三者的任意一项不匹配 targetOrigin 提供的值，那么消息就不会被发送；只有三者完全匹配，消息才会被发送。</li> <li><strong>transfer</strong>(可选)：是一串和 message 同时传递的 Transferable 对象. 这些对象的所有权将被转移给消息的接收方，而发送一方将不再保有所有权。</li></ul> <h3 id="websocket"><a href="#websocket" class="header-anchor">#</a> Websocket</h3> <p>Websocket 是 HTML5 的一个持久化的协议，它实现了浏览器与服务器的全双工通信，同时也是跨域的一种解决方案。WebSocket 和 HTTP 都是应用层协议，都基于 TCP 协议。但是 WebSocket 是一种双向通信协议，在建立连接之后，WebSocket 的 server 与 client 都能主动向对方发送或接收数据。同时，WebSocket 在建立连接时需要借助 HTTP 协议，连接建立好了之后 client 与 server 之间的双向通信就与 HTTP 无关了。</p> <h3 id="余下方法不再一一赘述"><a href="#余下方法不再一一赘述" class="header-anchor">#</a> 余下方法不再一一赘述</h3> <h2 id="浏览器多个窗口之间的通信方法"><a href="#浏览器多个窗口之间的通信方法" class="header-anchor">#</a> 浏览器多个窗口之间的通信方法</h2> <blockquote><p>借助 postMessage API</p></blockquote> <h3 id="_1-broadcastchannel-messagechannel"><a href="#_1-broadcastchannel-messagechannel" class="header-anchor">#</a> 1. BroadcastChannel / MessageChannel</h3> <p>MessageChannel 是一种点对点的通信方式（port1 和 port2），一般用于 iframe 与父页面之间的通信及多个 web worker 之间的通信</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// main.js</span>
<span class="token keyword">let</span> worker1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token string">&quot;./worker1.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> worker2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token string">&quot;./worker2.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> ms <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MessageChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 把 port1 分配给 worker1</span>
worker1<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">&quot;main&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>ms<span class="token punctuation">.</span>port1<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 把 port2 分配给 worker2</span>
worker2<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">&quot;main&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>ms<span class="token punctuation">.</span>port2<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
worker2<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// worker1.js</span>
<span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>data <span class="token operator">===</span> <span class="token string">&quot;from outernal&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      e<span class="token punctuation">.</span>ports<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">&quot;hi~ 我是worker1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// worker2.js</span>
<span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>data <span class="token operator">===</span> <span class="token string">&quot;from outernal&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    e<span class="token punctuation">.</span>ports<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">postMessage</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>BroastcastChannel 是一种广播形式的通信方式</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// page1</span>
<span class="token keyword">const</span> bc1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BroadcastChannel</span><span class="token punctuation">(</span><span class="token string">&quot;channel1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  bc1<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span> message<span class="token operator">:</span> <span class="token string">&quot;hello&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// page2</span>
bc2<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token parameter">eve</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;bc:&quot;</span><span class="token punctuation">,</span> eve<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> bc2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BroadcastChannel</span><span class="token punctuation">(</span><span class="token string">&quot;channel1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_2-sharedworker"><a href="#_2-sharedworker" class="header-anchor">#</a> 2. SharedWorker</h3> <p>SharedWorker和普通的WebWorker不同，WebWorker只属于某个页面，不会和其他页面的Render进程（浏览器内核进程）共享，SharedWorker是浏览器所有页面共享的，不能采用与Worker同样的方式实现，因为它不隶属于某个Render进程，可以为多个Render进程共享使用。二者本质上就是进程和线程的区别。SharedWorker由独立的进程管理，WebWorker只是属于render进程下的一个线程</p> <p>SharedWorker本身并不是为了解决通讯需求的，它的设计初衷应该是类似总控，将一些通用逻辑放在SharedWorker中处理，不过也能实现通讯</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// A.html</span>
<span class="token keyword">var</span> sharedworker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SharedWorker</span><span class="token punctuation">(</span><span class="token string">'worker.js'</span><span class="token punctuation">)</span>
sharedworker<span class="token punctuation">.</span>port<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
sharedworker<span class="token punctuation">.</span>port<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token parameter">evt</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token comment">// evt.data</span>
<span class="token punctuation">}</span>

<span class="token comment">// B.html</span>
<span class="token keyword">var</span> sharedworker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SharedWorker</span><span class="token punctuation">(</span><span class="token string">'worker.js'</span><span class="token punctuation">)</span>
sharedworker<span class="token punctuation">.</span>port<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
sharedworker<span class="token punctuation">.</span>port<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span>

<span class="token comment">// worker.js</span>
<span class="token keyword">const</span> ports <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token function-variable function">onconnect</span> <span class="token operator">=</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token keyword">const</span> port <span class="token operator">=</span> e<span class="token punctuation">.</span>ports<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
	ports<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span>
	port<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token parameter">evt</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		ports<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">v</span> <span class="token operator">=&gt;</span> v <span class="token operator">!==</span> port<span class="token punctuation">)</span> <span class="token comment">// 此处为了贴近其他方案的实现，剔除自己</span>
		<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">p</span> <span class="token operator">=&gt;</span> p<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span>evt<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_3-window-open-api（可跨域）"><a href="#_3-window-open-api（可跨域）" class="header-anchor">#</a> 3. window.open API（可跨域）</h3> <p>父页面通过 window.open(url, name)方式打开的子页面可以获取句柄，然后通过 postMessage 完成通讯需求(或者通过 window.opener)。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// parent.html</span>
<span class="token keyword">const</span> childPage <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'child.html'</span><span class="token punctuation">,</span> <span class="token string">'child'</span><span class="token punctuation">)</span>

childPage<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	childPage<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">,</span> location<span class="token punctuation">.</span>origin<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// child.html</span>
window<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token parameter">evt</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	<span class="token comment">// evt.data</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>不借助 postMessage API</p></blockquote> <h3 id="_4-onstorage-事件"><a href="#_4-onstorage-事件" class="header-anchor">#</a> 4. onstorage 事件</h3> <p>localstorage 是浏览器同域标签共用的存储空间，所以可以用来实现多标签之间的通信。html5 出现了一个事件： onstorage，我们在 window 对象上添加监听就可以监听到 localstorage 的变化。</p> <p><code>window.addEventListener('storage', (e) =&gt; console.log(e))</code></p> <p>需要注意，此事件是非当前页面对 localStorage 进行修改时才会触发，当前页面修改 localStorage 不会触发监听函数。</p> <h3 id="_5-轮询-cookie-或者-indexdb-变化（丑陋的方案）"><a href="#_5-轮询-cookie-或者-indexdb-变化（丑陋的方案）" class="header-anchor">#</a> 5. 轮询 Cookie 或者 indexDB 变化（丑陋的方案）</h3> <h3 id="_6-websocket（可跨域，可跨浏览器-跨设备）-不再赘述"><a href="#_6-websocket（可跨域，可跨浏览器-跨设备）-不再赘述" class="header-anchor">#</a> 6. Websocket（可跨域，可跨浏览器/跨设备） 不再赘述</h3></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/notes/browser/浏览器缓存策略.html" class="prev">浏览器缓存策略</a></span> <span class="next"><a href="/notes/browser/浏览器DOM事件与事件监听.html">浏览器DOM事件与事件监听</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.d90b1a7d.js" defer></script><script src="/assets/js/2.ddf9653e.js" defer></script><script src="/assets/js/28.f12de4e4.js" defer></script>
  </body>
</html>
