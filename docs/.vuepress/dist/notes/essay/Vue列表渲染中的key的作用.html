<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>key在Vue渲染列表时究竟起到了什么作用 | 学习笔记</title>
    <meta name="description" content="构建自己的前端知识体系">
    
    
    <link rel="preload" href="/assets/css/0.styles.a4aa4dff.css" as="style"><link rel="preload" href="/assets/js/app.a31d5691.js" as="script"><link rel="preload" href="/assets/js/2.ddf9653e.js" as="script"><link rel="preload" href="/assets/js/26.c372ecb9.js" as="script"><link rel="prefetch" href="/assets/js/10.803e4d7e.js"><link rel="prefetch" href="/assets/js/11.9b589f78.js"><link rel="prefetch" href="/assets/js/12.2c631f17.js"><link rel="prefetch" href="/assets/js/13.ed532cf2.js"><link rel="prefetch" href="/assets/js/14.bc847dfe.js"><link rel="prefetch" href="/assets/js/15.194eeda8.js"><link rel="prefetch" href="/assets/js/16.3a145252.js"><link rel="prefetch" href="/assets/js/17.9bde0b7b.js"><link rel="prefetch" href="/assets/js/18.fae57c73.js"><link rel="prefetch" href="/assets/js/19.8757e714.js"><link rel="prefetch" href="/assets/js/20.6d76ab7e.js"><link rel="prefetch" href="/assets/js/21.1a964119.js"><link rel="prefetch" href="/assets/js/22.2786dcc7.js"><link rel="prefetch" href="/assets/js/23.e8df8377.js"><link rel="prefetch" href="/assets/js/24.4485f615.js"><link rel="prefetch" href="/assets/js/25.a9579c95.js"><link rel="prefetch" href="/assets/js/27.b36f9827.js"><link rel="prefetch" href="/assets/js/28.566c95d4.js"><link rel="prefetch" href="/assets/js/29.50b60a1c.js"><link rel="prefetch" href="/assets/js/3.df3a87d4.js"><link rel="prefetch" href="/assets/js/30.58b622a8.js"><link rel="prefetch" href="/assets/js/31.3c3e73dd.js"><link rel="prefetch" href="/assets/js/32.c7bb1c1f.js"><link rel="prefetch" href="/assets/js/33.6bc9ec15.js"><link rel="prefetch" href="/assets/js/34.f91d14e7.js"><link rel="prefetch" href="/assets/js/35.7b39f7b8.js"><link rel="prefetch" href="/assets/js/36.021c5937.js"><link rel="prefetch" href="/assets/js/37.4441c601.js"><link rel="prefetch" href="/assets/js/4.554dccb8.js"><link rel="prefetch" href="/assets/js/5.7ec69b64.js"><link rel="prefetch" href="/assets/js/6.fd22e7cc.js"><link rel="prefetch" href="/assets/js/7.55ca8e68.js"><link rel="prefetch" href="/assets/js/8.e401c731.js"><link rel="prefetch" href="/assets/js/9.6cc258f0.js">
    <link rel="stylesheet" href="/assets/css/0.styles.a4aa4dff.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">学习笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/notes/" class="nav-link router-link-active">前端笔记</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/notes/" class="nav-link router-link-active">前端笔记</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>浏览器知识</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/notes/browser/浏览器的进程与线程.html" class="sidebar-link">浏览器的进程与线程</a></li><li><a href="/notes/browser/浏览器的渲染原理.html" class="sidebar-link">浏览器的渲染原理</a></li><li><a href="/notes/browser/浏览器JS引擎.html" class="sidebar-link">浏览器JS引擎（V8）</a></li><li><a href="/notes/browser/浏览器EventLoop.html" class="sidebar-link">EventLoop</a></li><li><a href="/notes/browser/浏览器缓存策略.html" class="sidebar-link">浏览器缓存策略</a></li><li><a href="/notes/browser/跨域与页面通信.html" class="sidebar-link">跨域与页面通信</a></li><li><a href="/notes/browser/浏览器DOM事件与事件监听.html" class="sidebar-link">浏览器DOM事件与事件监听</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>网络知识</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/notes/network/网络知识.html" class="sidebar-link">网络知识</a></li><li><a href="/notes/network/Web安全.html" class="sidebar-link">Web安全 —— XSS 与 CSRF</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>JavaScript进阶</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/notes/advanced/JS执行上下文栈.html" class="sidebar-link">JS执行上下文栈</a></li><li><a href="/notes/advanced/原型链与继承.html" class="sidebar-link">原型链继承</a></li><li><a href="/notes/advanced/Generator.html" class="sidebar-link">Generator</a></li><li><a href="/notes/advanced/Promise.html" class="sidebar-link">Promise</a></li><li><a href="/notes/advanced/Proxy.html" class="sidebar-link">Proxy</a></li><li><a href="/notes/advanced/节流和防抖.html" class="sidebar-link">函数的节流和防抖</a></li><li><a href="/notes/advanced/函数柯里化.html" class="sidebar-link">函数柯里化</a></li><li><a href="/notes/advanced/bind和call和apply.html" class="sidebar-link">bind-call-apply</a></li><li><a href="/notes/advanced/常见算法.html" class="sidebar-link">常见算法</a></li><li><a href="/notes/advanced/单例模式.html" class="sidebar-link">JavaScript 中单例设计模式的应用</a></li><li><a href="/notes/advanced/观察者模式.html" class="sidebar-link">观察者模式的简单实现</a></li><li><a href="/notes/advanced/使用setTimeout模拟setInterval.html" class="sidebar-link">封装一个 Timer 类，用 setTimeout 实现 setInterval</a></li><li><a href="/notes/advanced/new运算符.html" class="sidebar-link">JavaScript中的new运算符到底做了什么</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>其他知识</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/notes/others/模块加载机制.html" class="sidebar-link">模块加载机制</a></li><li><a href="/notes/others/前端性能优化.html" class="sidebar-link">前端性能优化</a></li><li><a href="/notes/others/移动端适配方案.html" class="sidebar-link">移动端适配方案</a></li><li><a href="/notes/others/Vue与React的区别.html" class="sidebar-link">Vue与React的区别</a></li><li><a href="/notes/others/面试题整理.html" class="sidebar-link">一些JS面试题整理</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>个人随笔</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/notes/essay/给ReactRouter添加转场动画.html" class="sidebar-link">给React-Router添加路由页面切换时的过渡动画</a></li><li><a href="/notes/essay/Vue列表渲染中的key的作用.html" class="active sidebar-link">key在Vue渲染列表时究竟起到了什么作用</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/notes/essay/Vue列表渲染中的key的作用.html#设置key的可以在diff中更快速的找到对应节点，提高diff速度" class="sidebar-link">设置key的可以在diff中更快速的找到对应节点，提高diff速度</a></li><li class="sidebar-sub-header"><a href="/notes/essay/Vue列表渲染中的key的作用.html#那么设置key值就一定能提高diff效率吗？" class="sidebar-link">那么设置key值就一定能提高diff效率吗？</a></li><li class="sidebar-sub-header"><a href="/notes/essay/Vue列表渲染中的key的作用.html#总结" class="sidebar-link">总结</a></li></ul></li><li><a href="/notes/essay/vue源码阅读知识点整理.html" class="sidebar-link">Vue 源码阅读知识点整理</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="key在vue渲染列表时究竟起到了什么作用"><a href="#key在vue渲染列表时究竟起到了什么作用" class="header-anchor">#</a> key在Vue渲染列表时究竟起到了什么作用</h1> <p>Vue2+采用<code>diff</code>算法来进行新旧<code>vnode</code>的对比从而更新DOM节点。而通常在我们使用<code>v-for</code>这个指令的时候，<code>Vue</code>会要求你给循环列表的每一项添加唯一的<code>key</code>，那么这个<code>key</code>在渲染列表时究竟起到了什么作用呢？</p> <p>在解释这一点之前，你最好已经了解<code>Vue</code>的<code>diff</code>算法的具体原理是什么。</p> <p>Vue2更新真实DOM节点的操作主要是两种：<strong>创建新DOM节点并移除旧DOM节点</strong> 和 <strong>更新已存在的DOM节点</strong>，这两种方式里创建新DOM节点的开销肯定是远大于移动已有DOM节点位置或更新DOM节点属性的，所以在<code>diff</code>中逻辑都是为了减少新的创建而更多的去复用已有DOM节点来完成DOM的更新。</p> <p>在新旧<code>vnode</code>的<code>diff</code>过程中，<code>key</code>是判断两个节点是否为同一节点的首要条件：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>
<span class="token comment">// 参见Vue2源码 core/vdom/patch.js</span>

<span class="token keyword">function</span> <span class="token function">sameVnode</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
        a<span class="token punctuation">.</span>key <span class="token operator">===</span> b<span class="token punctuation">.</span>key <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>
            <span class="token punctuation">(</span>
                a<span class="token punctuation">.</span>tag <span class="token operator">===</span> b<span class="token punctuation">.</span>tag <span class="token operator">&amp;&amp;</span>
                a<span class="token punctuation">.</span>isComment <span class="token operator">===</span> b<span class="token punctuation">.</span>isComment <span class="token operator">&amp;&amp;</span>
                <span class="token function">isDef</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token function">isDef</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                <span class="token function">sameInputType</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span>
            <span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>
                <span class="token function">isTrue</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>isAsyncPlaceholder<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                a<span class="token punctuation">.</span>asyncFactory <span class="token operator">===</span> b<span class="token punctuation">.</span>asyncFactory <span class="token operator">&amp;&amp;</span>
                <span class="token function">isUndef</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>asyncFactory<span class="token punctuation">.</span>error<span class="token punctuation">)</span>
            <span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre></div><p>值得注意的是，如果新旧<code>vnode</code>的<code>key</code>值都未定义的话那么两个<code>key</code>都为<code>undefined</code>，<code>a.key === b.key</code> 是成立的</p> <p>接下来是在<code>updateChildren</code>方法中</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>
<span class="token comment">// 参见Vue2源码 core/vdom/patch.js</span>

<span class="token keyword">function</span> <span class="token function">updateChildren</span> <span class="token punctuation">(</span><span class="token parameter">parentElm<span class="token punctuation">,</span> oldCh<span class="token punctuation">,</span> newCh<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> removeOnly</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>oldStartIdx <span class="token operator">&lt;=</span> oldEndIdx <span class="token operator">&amp;&amp;</span> newStartIdx <span class="token operator">&lt;=</span> newEndIdx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token operator">...</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token operator">...</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token operator">...</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span> newEndVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token operator">...</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldStartVnode<span class="token punctuation">,</span> newEndVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// Vnode moved right</span>
            <span class="token operator">...</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldEndVnode<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// Vnode moved left</span>
            <span class="token operator">...</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>oldKeyToIdx<span class="token punctuation">)</span><span class="token punctuation">)</span> oldKeyToIdx <span class="token operator">=</span> <span class="token function">createKeyToOldIdx</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">,</span> oldStartIdx<span class="token punctuation">,</span> oldEndIdx<span class="token punctuation">)</span>
            idxInOld <span class="token operator">=</span> <span class="token function">isDef</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">.</span>key<span class="token punctuation">)</span>
                <span class="token operator">?</span> oldKeyToIdx<span class="token punctuation">[</span>newStartVnode<span class="token punctuation">.</span>key<span class="token punctuation">]</span>
                <span class="token operator">:</span> <span class="token function">findIdxInOld</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">,</span> oldCh<span class="token punctuation">,</span> oldStartIdx<span class="token punctuation">,</span> oldEndIdx<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>idxInOld<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// New element</span>
                <span class="token function">createElm</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> parentElm<span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> newCh<span class="token punctuation">,</span> newStartIdx<span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                vnodeToMove <span class="token operator">=</span> oldCh<span class="token punctuation">[</span>idxInOld<span class="token punctuation">]</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>vnodeToMove<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">patchVnode</span><span class="token punctuation">(</span>vnodeToMove<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> newCh<span class="token punctuation">,</span> newStartIdx<span class="token punctuation">)</span>
                    oldCh<span class="token punctuation">[</span>idxInOld<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">undefined</span>
                    canMove <span class="token operator">&amp;&amp;</span> nodeOps<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> vnodeToMove<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token punctuation">)</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment">// same key but different element. treat as new element</span>
                    <span class="token function">createElm</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> parentElm<span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> newCh<span class="token punctuation">,</span> newStartIdx<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            newStartVnode <span class="token operator">=</span> newCh<span class="token punctuation">[</span><span class="token operator">++</span>newStartIdx<span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="设置key的可以在diff中更快速的找到对应节点，提高diff速度"><a href="#设置key的可以在diff中更快速的找到对应节点，提高diff速度" class="header-anchor">#</a> 设置<code>key</code>的可以在<code>diff</code>中更快速的找到对应节点，提高<code>diff</code>速度</h2> <p>在<code>updateChildren</code>方法的<code>while</code>循环中，如果<strong>头尾交叉对比</strong>没有结果，即<code>oldStartVnode</code>存在且<code>oldEndVnode</code>存在且新旧<code>children</code>首尾四个<code>vnode</code>互不相同的条件下，会根据<code>newStartVnode</code>的<code>key</code>去对比<code>oldCh</code>数组中的<code>key</code>，从而找到相应<code>oldVnode</code></p> <p>首先通过<code>createKeyToOldIdx</code>方法创建一个关于<code>oldCh</code>的<code>map</code></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>oldKeyToIdx<span class="token punctuation">)</span><span class="token punctuation">)</span> oldKeyToIdx <span class="token operator">=</span> <span class="token function">createKeyToOldIdx</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">,</span> oldStartIdx<span class="token punctuation">,</span> oldEndIdx<span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">createKeyToOldIdx</span> <span class="token punctuation">(</span><span class="token parameter">children<span class="token punctuation">,</span> beginIdx<span class="token punctuation">,</span> endIdx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> i<span class="token punctuation">,</span> key
    <span class="token keyword">const</span> map <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> beginIdx<span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> endIdx<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        key <span class="token operator">=</span> children<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>key
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> map<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> i
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> map
<span class="token punctuation">}</span>
</code></pre></div><p>这个<code>map</code>中将所有定义了<code>key</code>的<code>oldVnode</code>在数组中的<code>index</code>值作为键值，它的<code>key</code>作为键名存储起来，然后赋给<code>oldKeyToIdx</code></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>idxInOld <span class="token operator">=</span> <span class="token function">isDef</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token operator">?</span> oldKeyToIdx<span class="token punctuation">[</span>newStartVnode<span class="token punctuation">.</span>key<span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token function">findIdxInOld</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">,</span> oldCh<span class="token punctuation">,</span> oldStartIdx<span class="token punctuation">,</span> oldEndIdx<span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">findIdxInOld</span> <span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span> oldCh<span class="token punctuation">,</span> start<span class="token punctuation">,</span> end</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> start<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> end<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> c <span class="token operator">=</span> oldCh<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">sameVnode</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> i
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如果<code>newStartVnode</code>的<code>key</code>存在的话，就去<code>oldKeyToIdx</code>中寻找相同<code>key</code>所对应的<code>index</code>值，这样就能拿到跟<code>newStartVnode</code>的<code>key</code>相同的<code>oldVnode</code>在<code>oldCh</code>数组中的<code>index</code>，即得到了与<code>newStartVnode</code>对应的<code>oldVnode</code>。如果找不到的话，那么<code>idxInOld</code>就为<code>undefined</code>。</p> <p>而如果<code>newStartVnode</code>并没有设置<code>key</code>，则通过<code>findIdxInOld</code>方法遍历<code>oldCh</code>来获取与<code>newStartVnode</code>互为<code>sameVnode</code>的<code>oldVnode</code>，返回这个<code>oldVnode</code>在<code>oldCh</code>数组的<code>index</code>。（前面介绍过，<code>Vue</code>在更新真实DOM时倾向于真实DOM节点的复用，所以在这里还是会选择去找对应的<code>oldVnode</code>，来更新已有的DOM节点）</p> <p>这时候设置<code>key</code>的好处就显而易见了，有<code>key</code>存在时我们可以通过<code>map</code>映射快速定位到对应的<code>oldVnode</code>然后进行<code>patch</code>，没有<code>key</code>值时我们需要遍历这个<code>oldCh</code>数组然后去一一进行比较，相比之下肯定是<code>key</code>存在时<code>diff</code>更高效。</p> <p>接下来就是更新DOM的过程，如果<code>oldCh[idxInOld]</code>存在且与<code>newStartVnode</code>互为<code>sameVnode</code>存在则先更新再移动，否则创建新的<code>element</code></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUndef</span><span class="token punctuation">(</span>idxInOld<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// New element</span>
    <span class="token function">createElm</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> parentElm<span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> newCh<span class="token punctuation">,</span> newStartIdx<span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    vnodeToMove <span class="token operator">=</span> oldCh<span class="token punctuation">[</span>idxInOld<span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>vnodeToMove<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">patchVnode</span><span class="token punctuation">(</span>vnodeToMove<span class="token punctuation">,</span> newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> newCh<span class="token punctuation">,</span> newStartIdx<span class="token punctuation">)</span>
        oldCh<span class="token punctuation">[</span>idxInOld<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">undefined</span>
        canMove <span class="token operator">&amp;&amp;</span> nodeOps<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>parentElm<span class="token punctuation">,</span> vnodeToMove<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// same key but different element. treat as new element</span>
        <span class="token function">createElm</span><span class="token punctuation">(</span>newStartVnode<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">,</span> parentElm<span class="token punctuation">,</span> oldStartVnode<span class="token punctuation">.</span>elm<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> newCh<span class="token punctuation">,</span> newStartIdx<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="那么设置key值就一定能提高diff效率吗？"><a href="#那么设置key值就一定能提高diff效率吗？" class="header-anchor">#</a> 那么设置<code>key</code>值就一定能提高<code>diff</code>效率吗？</h2> <p>答案是否定的</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>
<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div v-for=&quot;i in arr&quot;&gt;{{ i }}&lt;/div&gt;</span><span class="token template-punctuation string">`</span></span>

<span class="token comment">// 如果我们的数组是这样的</span>
<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span>

<span class="token comment">// 它的渲染结果是这样的</span>
<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div&gt;1&lt;/div&gt;</span><span class="token template-punctuation string">`</span></span>  <span class="token comment">// key: undefined</span>
<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div&gt;2&lt;/div&gt;</span><span class="token template-punctuation string">`</span></span>  <span class="token comment">// key: undefined</span>
<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div&gt;3&lt;/div&gt;</span><span class="token template-punctuation string">`</span></span>  <span class="token comment">// key: undefined</span>
<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div&gt;4&lt;/div&gt;</span><span class="token template-punctuation string">`</span></span>  <span class="token comment">// key: undefined</span>
<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div&gt;5&lt;/div&gt;</span><span class="token template-punctuation string">`</span></span>  <span class="token comment">// key: undefined</span>

<span class="token comment">// 将它打乱</span>
<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>

<span class="token comment">// 渲染结果是这样的 期间只发生了DOM节点的文本内容的更新</span>
<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div&gt;4&lt;/div&gt;</span><span class="token template-punctuation string">`</span></span>  <span class="token comment">// key: undefined</span>
<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div&gt;1&lt;/div&gt;</span><span class="token template-punctuation string">`</span></span>  <span class="token comment">// key: undefined</span>
<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div&gt;3&lt;/div&gt;</span><span class="token template-punctuation string">`</span></span>  <span class="token comment">// key: undefined</span>
<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div&gt;5&lt;/div&gt;</span><span class="token template-punctuation string">`</span></span>  <span class="token comment">// key: undefined</span>
<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div&gt;2&lt;/div&gt;</span><span class="token template-punctuation string">`</span></span>  <span class="token comment">// key: undefined</span>


<span class="token comment">// 如果我们给这个数组每一项都设置了唯一的key</span>
<span class="token punctuation">[</span><span class="token punctuation">{</span>id<span class="token operator">:</span> <span class="token string">'A'</span><span class="token punctuation">,</span> value<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>id<span class="token operator">:</span> <span class="token string">'B'</span><span class="token punctuation">,</span> value<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>id<span class="token operator">:</span> <span class="token string">'C'</span><span class="token punctuation">,</span> value<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>id<span class="token operator">:</span> <span class="token string">'D'</span><span class="token punctuation">,</span> value<span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>id<span class="token operator">:</span> <span class="token string">'E'</span><span class="token punctuation">,</span> value<span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">}</span><span class="token punctuation">]</span>

<span class="token comment">// 它的渲染结果应该是这样的</span>
<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div&gt;1&lt;/div&gt;</span><span class="token template-punctuation string">`</span></span>  <span class="token comment">// key: A</span>
<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div&gt;2&lt;/div&gt;</span><span class="token template-punctuation string">`</span></span>  <span class="token comment">// key: B</span>
<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div&gt;3&lt;/div&gt;</span><span class="token template-punctuation string">`</span></span>  <span class="token comment">// key: C</span>
<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div&gt;4&lt;/div&gt;</span><span class="token template-punctuation string">`</span></span>  <span class="token comment">// key: D</span>
<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div&gt;5&lt;/div&gt;</span><span class="token template-punctuation string">`</span></span>  <span class="token comment">// key: E</span>

<span class="token comment">// 将它打乱</span>
<span class="token punctuation">[</span><span class="token punctuation">{</span>id<span class="token operator">:</span> <span class="token string">'D'</span><span class="token punctuation">,</span> value<span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>id<span class="token operator">:</span> <span class="token string">'A'</span><span class="token punctuation">,</span> value<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>id<span class="token operator">:</span> <span class="token string">'C'</span><span class="token punctuation">,</span> value<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>id<span class="token operator">:</span> <span class="token string">'E'</span><span class="token punctuation">,</span> value<span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>id<span class="token operator">:</span> <span class="token string">'B'</span><span class="token punctuation">,</span> value<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">]</span>

<span class="token comment">// 渲染结果是这样的  期间只发生了DOM节点的移动</span>
<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div&gt;4&lt;/div&gt;</span><span class="token template-punctuation string">`</span></span>  <span class="token comment">// key: D</span>
<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div&gt;1&lt;/div&gt;</span><span class="token template-punctuation string">`</span></span>  <span class="token comment">// key: A</span>
<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div&gt;3&lt;/div&gt;</span><span class="token template-punctuation string">`</span></span>  <span class="token comment">// key: C</span>
<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div&gt;5&lt;/div&gt;</span><span class="token template-punctuation string">`</span></span>  <span class="token comment">// key: E</span>
<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;div&gt;2&lt;/div&gt;</span><span class="token template-punctuation string">`</span></span>  <span class="token comment">// key: B</span>
</code></pre></div><p>我们给数组设置了<code>key</code>之后数组的<code>diff</code>效率真的变高了吗？</p> <p>并没有，因为在简单模板的数组渲染中，新旧节点的<code>key</code>都为<code>undefined</code>，根据<code>sameVnode</code>的判断条件，这些新旧节点的<code>key</code>、<code>tag</code>等属性全部相同，所以在<code>sameVnode(oldStartVnode, newStartVnode)</code>这一步的时候就已经判定为对应的节点（不再执行头尾交叉对比），然后直接进行<code>patchVnode</code>，根本没有走后面的那些<code>else</code>。每一次循环新旧节点都是相对应的，只需要更新其内的文本内容就可以完成DOM更新，这种<strong>原地复用</strong>的效率无疑是最高的。</p> <p>而当我们设置了<code>key</code>之后，则会根据<strong>头尾交叉对比</strong>结果去执行下面的<code>if else</code>，进行判断之后还需要执行<code>insertBefore</code>等方法移动真实DOM的节点的位置或者进行DOM节点的添加和删除，这样的<strong>查找复用</strong>开销肯定要比不带<code>key</code>直接<strong>原地复用</strong>的开销要高。</p> <p>Vue文档中对此也进行了说明：</p> <blockquote><p>当 Vue.js 用 v-for 正在更新已渲染过的元素列表时，它默认用“就地复用”策略。如果数据项的顺序被改变，Vue 将不会移动 DOM 元素来匹配数据项的顺序， 而是简单复用此处每个元素，并且确保它在特定索引下显示已被渲染过的每个元素。</p></blockquote> <blockquote><p>这个默认的模式是高效的，但是只适用于不依赖子组件状态或临时 DOM 状态 (例如：表单输入值) 的列表渲染输出。</p></blockquote> <blockquote><p>建议尽可能在使用 v-for 时提供 key，除非遍历输出的 DOM 内容非常简单，或者是刻意依赖默认行为以获取性能上的提升。</p></blockquote> <p>所以，简单列表的渲染可以不使用<code>key</code>或者用数组的<code>index</code>作为<code>key</code>（效果等同于不带<code>key</code>），这种模式下性能最高，但是并不能准确的更新列表项的状态。一旦你需要保存列表项的状态，那么就需要用使用唯一的<code>key</code>用来准确的定位每一个列表项以及复用其自身的状态，而大部分情况下列表组件都有自己的状态。</p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p><code>key</code>在列表渲染中的作用是：在复杂的列表渲染中快速准确的找到与<code>newVnode</code>相对应的<code>oldVnode</code>，提升<code>diff</code>效率</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/notes/essay/给ReactRouter添加转场动画.html" class="prev">给React-Router添加路由页面切换时的过渡动画</a></span> <span class="next"><a href="/notes/essay/vue源码阅读知识点整理.html">Vue 源码阅读知识点整理</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.a31d5691.js" defer></script><script src="/assets/js/2.ddf9653e.js" defer></script><script src="/assets/js/26.c372ecb9.js" defer></script>
  </body>
</html>
